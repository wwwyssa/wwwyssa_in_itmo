# Сети и потоки. Разрез сети. Лемма о потоке через разрез.
## Сеть
Задано множество вершин V, в котором выделены две вершины: s (**вход** или **исток**) и t (**выход** или **сток**). 
Определена функция $c: V \times V \to \R$, удовлетворяющая для любых вершин $x,y \in V$ соотношениям
1) $c(x, y) \geq  0$,
2) c(x, s) = 0,
3) c(t, y) = 0

Тогда $G = (V, s, t, c)$ - **cеть**, функция c называется **пропускной способностью** сети $G$. 
Множество $A(G) =\{(x, y) : c(x, y) > 0\}$ называется **множеством стрелок** сети G.

## Поток
## Определение  
   
 Пусть $G$ — сеть, а функция $f : V \times V \to \mathbb{R}$ удовлетворяет трём условиям:  
   
 - $(F1)$ для любых $x, y \in V$, $f(x, y) \leq c(x, y)$;  
 - $(F2)$ для любых $x, y \in V$, $f(x, y) = -f(y, x)$;  
 - $(F3)$ для любой вершины $v \in V$, $v \neq s, t$ выполняется условие:  
  $\sum_{x \in V} f(v, x) = 0.$  
 - Тогда $f$ — поток в сети $G$. 
 - Число $|f| = \sum_{x \in V} f(s, x)$  
  называется величиной потока. 
- Поток сети $G$ с максимальной величиной называется **максимальным**. 
 
   
 Вообще-то не очевидно, что максимальный поток существует.
### Пояснение 
![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/7.png?raw=true)
## Разрез

### Определение

1. Пусть $G$ — сеть, а множество её вершин $V$ разбито на два непересекающихся множества $S \ni s$ и $T \ni t$. Тогда $(S, T)$ — **разрез** сети $G$.
2. Величина $\displaystyle c(S, T) = \sum_{x \in S, y \in T} c(x, y)$ называется **пропускной способностью разреза.**
3. Любой разрез сети $G$ с минимальной пропускной способностью называется **минимальным**.
4. Для любого потока $f$ в сети $G$ величина $\displaystyle f(S, T) = \sum_{x \in S, y \in T} f(x, y)$ называется потоком через разрез $(S, T)$.
![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/1.png?raw=true)
Нетрудно понять, что минимальный разрез сети существует. Возможно, таких разрезов несколько.

## Лемма 1  
  Для любого потока $f$ и разреза $(S, T)$ сети $G$ выполняется $|f| = f(S, T)$ .  
   
 ### Доказательство  
  Ввиду условия $(F3)$:  
   
 $$  
  |f| = \sum_{x \in V} f(s, x) = \sum_{x \in V} \sum_{y \in S} f(y, x).  
 $$  
  В правой части равенства для любых двух вершин $y, z \in S$ присутствуют слагаемые $f(y, z)$ и $f(z, y)$, которые в силу $(F2)$ в сумме дают $0$. Поэтому:  
   
 $$  
  \sum_{y \in S} \sum_{x \in V} f(y, x) = \sum_{y \in S} \sum_{x \in T} f(y, x), = f(S, T)  
 $$  
  что и требовалось доказать.

# Остаточная сеть и дополняющий путь. Лемма о сумме потоков. Поток вдоль пути

## Остаточная сеть. Дополняющий путь  
 
  ### Определение  
 1. Пусть $f$ — поток в сети $G$. Рассмотрим сеть $G_f$ с теми же $V$, $s$, $t$ и пропускной способностью:  
   
 $$  
  c_f(x, y) =  
 \begin{cases}   
 0, & \text{если } y = s \text{ или } x = t, \\  
 c(x, y) - f(x, y), & \text{в остальных случаях}.  
 \end{cases}  
 $$  
  Назовем $G_f$ **остаточной сетью** потока $f$.  
   
 2. **Дополняющий путь** потока $f$ — это любой $s$$t$-путь в остаточной сети $G_f$.  
 ![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/8.png?raw=true)
   
 ### Лемма 2  
  Пусть $f$ — поток в сети $G$, $f'$ — поток в сети $G_f$. Тогда $f + f'$ — поток в сети $G$, причём:  
   
 $$  
  |f + f'| = |f| + |f'|.  
 $$  
  ### Доказательство  
  Нетрудно проверить для потока $f + f'$ условия $(F1)$, $(F2)$ и $(F3)$. Утверждение про величину потока очевидно.

## Поток вдоль пути
Определение Пусть $P -st$-путь в сети G, а $c  -$ минимальная пропускная способность стрелки пути $P$. Определим поток $f_P$  **вдоль пути** $P$:

$f_p(x,y) = c$ при $xy \in A(P)$, $f_p(x,y) = -c$, при $yx \in A(P)$, $f_p(x,y)=0$ при $xy, yx \not\in A(P)$
 ![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/2.png?raw=true)

# Теорема Форда-Фалкерсона и следствие о минимальном разрезе.

## Теорема 1  
   
 ### (L. R. Ford, D. R. Fulkerson, 1956.)  
  В сети $G = (V, s, t, c)$ задан поток $f$. Тогда следующие три утверждения равносильны:  
   
 1. Поток $f$ максимален.  
 2. Существует такой разрез $(S, T)$, что $|f| = c(S, T)$.  
 3. В остаточной сети $G_f$ нет дополняющего пути.  
   
 ### Доказательство  
  $2 \implies 1$. Рассмотрим другой поток $f'$. По [Лемме 1](#лемма-1):  
   
 $$  
   |f'| = f^′(S, T) = \sum_{x \in S, y \in T} f'(x, y) \leq \sum_{x \in S, y \in T} c(x, y) = c(S, T) = f,  
 $$  
  откуда следует максимальность $f$.

 $1 \implies 3$
Предположим противное, пусть в остаточной сети $G_f$ есть дополняющий путь $P$, а $f_P$ — поток вдоль пути $P$. По [Лемме 2](#лемма-2) тогда $f + f_P$ — поток в $G$, причём:

$$
f + f_P = f + f_P > f,
$$

что противоречит максимальности $f$.

![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/3.png?raw=true)


$3 \implies 2$
- Пусть $S$ — множество всех вершин, достижимых из $s$ в остаточной сети $G_f$ (см. рисунок).  
  
 - Так как в $G_f$ нет дополняющего пути, то $t \notin S$. Тогда $(S, T = V \setminus S)$ — разрез в сетях $G$ и $G_f$.   
  
- По построению $A_{G_f}(S, T) = \emptyset$, следовательно:  
  
$$  
0 = c_f(S, T) = c(S, T) - f(S, T),  
$$  
  
откуда:  
  
$$  
c(S, T) = f(S, T) = f  
$$  
  
(последнее равенство следует из Леммы 1).
## Следствие 1 
Величина максимального потока в сети G равна пропускной способности минимального разреза сети G.
## Доказательство. 
- Рассмотрим максимальный поток $f$ и такой разрез $(S,T)$, что $f =c(S,T)$ (такой разрез существует по теореме 1).
- Тогда для любого другого разреза $(S^′, T^′)$ мы имеем $c(S^′, T^′)\geq  f(S^′, T^′)=f(S, T)=c(S, T)$ Значит, разрез $(S, T)$ минимален.

# Целые сети. Целый максимальный поток в целой сети.
## Определение 
- Сеть $G$ называется **целой**, если ее пропускная способность $c$ -- **целочисленная**. 
- Поток $f$ называется **целым**, если на любой паре вершин он принимает **целочисленное** значение.

## Теорема 2

В целой сети $G$ существует максимальный поток. Среди максимальных потоков целой сети найдется целый. 
## Доказательство.
- Будем последовательно строить поток. Изначально положим f = 0. 
- Пусть в некоторый момент есть целый поток $f$ в целочисленной сети $G$. Рассмотрим остаточную сеть $G_f$. Если в $G_f$ нет дополняющего пути $P$, то по [Теореме 1](#теорема-1) поток $f$ максимальный. 
- Если же в $G_f$ есть дополняющий путь $P$, то рассмотрим поток $f_P$ вдоль пути $P$ в остаточной сети $G_f$ и положим $f := f +f_P$. 
- По [Лемме 2](#лемма-2) мы построили новый целый поток в $G$, причем его пропускная способность на $|f_P|$ больше, чем у предыдущего. 
- Так как с каждым шагом величина потока возрастает на целую величину (хотя бы на 1), процесс обязательно закончится, в результате мы получим целый максимальный поток в сети $G$.

# Реберная теорема Менгера как следствие теоремы Форда-Фалкерсона.

## Определение 
Пусть $G$ -- неориентированный граф без петель, кратные рёбра допускаются. 
Для $x, y \in V(G)$ обозначим через $\lambda_G(x, y)$ размер минимального множества рёбер, отделяющего $x$ от $y$. Назовем $\lambda_G(x, y)$ рёберной связностью вершин $x$ и $y$.

## Теорема 3 
**(L. R.Ford, D.R.Fulkerson, 1956.)** Пусть $s, t \in V(G)$. Тогда существует $\lambda_G(s, t)$ путей из $s$ в $t$, не имеющих общих рёбер.

## Доказательство. 
- Построим сеть $\vec{G}$ на множестве вершин $V(G)$. Входом будет $s$, выходом будет $t$.
- Определим пропускные способности: $c(x, y)$ равняется кратности ребра $xy$ в графе $G$ (то есть, 0, если такого ребра нет, и $m$, если в графе $G$ есть $m$ кратных рёбер $xy$). Дополнительно определим $c(x, s) = c(t, x) = 0$ для всех $x \in V(G)$.
- Отметим, что при $x, y \not\in \{s, t\}$ мы имеем $c(x, y) = c(y, x)$.
- Сеть $\vec{G}$ целая. По [Теореме 2](#теорема-2) в ней есть целый максимальный поток $f$. Пусть $|f| = k$.
### Утверждение
Поток $f$ распадается на $k$ $st$-путей без общих рёбер.
### Доказательство
- Построим новый орграф $G^′$ на тех же вершинах. Если $f (x, y) = l > 0$ для $x, y \in V(G)$, мы проведем в $G^′$ ровно $l$ стрелок $xy$.
- Понятно, что $l \in \Z$ и в графе $G$ есть не менее $l$ ребер, соединяющих $x$ и $y$.
- Из вершины $s$ выходит ровно $k$ стрелок, а в каждой отличной от $s$ и $t$ вершине $v$ по свойству потока ($F3$) количества входящих и выходящих стрелок равны (см. рис.а). Встречных стрелок по свойству ($F2$) потока нет.
![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/4.png?raw=true)
- Выйдем из $s$ и будем каждый раз проходить по стрелке орграфа $G^′$, по которой еще не ходили. В некоторый момент мы достигнем $t$ (если в любую другую вершину мы вошли, сможем и выйти, см. рис.b). 
![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/5.png?raw=true)
-Удалим из $G^′$ стрелки пройденного пути, теперь из $s$ выходит $k-1$ стрелка. Повторим эти действия еще $k-1$ раз. В результате будет выделено $k$ непересекающихся по рёбрам $st$-путей в графе $G$ (не обязательно простых).
- Вернемся к доказательству Теоремы 3. По [Теореме 1](#теорема-1) для максимального потока $f$ существует такой разрез ($S, T$) нашей сети, что $c(S, T) = f = k$.
- Тогда из $S$ в $T$ выходит ровно $k$ рёбер графа $G$ (так как для $x \in  S$и $y \in  T$ пропускная способность $c(x, y)$ равна количеству рёбер между $x$ и $y$). Эти $k$ рёбер отделяют $S$ от $T$, а стало быть, и $s$ от $t$ в графе $G$. Значит, $k \geq  \lambda_G(s, t)$.

### Определение 
Граф называется **рёберно $k$-связным**, если он остается связным после удаления любого множества, состоящего из менее чем $k$ рёбер. 
### Следствие
 В рёберно $k$-связном графе $G$ для любых двух вершин $s, t$ существует $k$ путей из $s$ в $t$, не имеющих общих рёбер.
 ### Доказательство.
 Достаточно применить Теорему 3 к паре вершин $s$ и $t$.


# Максимальный поток в произвольной сети. Алгоритм кратчайшего пути
## Теорема 4 
**(Е.А.Диниц, 1970).** В произвольной сети G существует максимальный поток.

## Доказательство
- План доказательства такой же, как и в [Теореме 2](#теорема-2): мы будем постепенно увеличивать максимальный поток, добавляя к нему поток вдоль дополняющего пути. Однако, на этот раз нам нельзя произвольно выбирать дополняющий путь.
- Пусть в некоторый момент построен поток $f$ в сети $G$. Рассмотрим остаточную сеть $G_f$. Если в $G_f$ нет дополняющего пути $P$, то по [Теореме 1](#теорема-1) поток f максимальный. Пусть в $G_f$ есть дополняющие пути.
- Мы выберем самый короткий дополняющий путь $P$ в $G_f$ , рассмотрим поток $f_P$ вдоль пути $P$ и положим $f^′ :=f +f_P$. Почему же этот процесс когда-нибудь закончится?
### Утверждение
Пусть $Q$ -- простой $st$-путь в остаточной сети $G_{f^′}$, которого нет в остаточной сети $G_f$. Тогда $Q$ длиннее, чем $P$.
### Доказательство. 
- Пусть $s = x_0x_1\dots x_k$ = t это путь $P$. Понятно, что путь $P$ простой, а значит, все его вершины различны.
 - Сначала поймем, какие же стрелки могут входить в $A(G_{f ^′} )$ \  $A(G_f)$. Такая стрелка $yz$ имеет $c_f(y, z) = 0$, но $0 < c_{f^′}(y, z) = c_f(y, z) - f_p(y, z).$ Значит, $zy \in A(P)$, то есть, $z = x_i$ и $y = x_{i+1}$ для некоторого $i$. По условию, путь $Q$ содержит хотя бы одну такую стрелку.
 - **Трансверсаль** пути $P$ это путь между двумя его вершинами, внутренние вершины которого не принадлежат $P$.
 - Назовём $x_ix_j$-трансверсаль $L$ пути $P$ **правильной**, если $i < j$ и **неправильной** в противном случае.
 - Стрелку $x_ix_{i+1}$, мы будем считать правильной трансверсалью пути $P$, а стрелку $x_{i+1}x_i$ неправильной.
![Рисунок a](https://github.com/wwwyssa/wwwyssa_in_itmo/blob/main/sexia_part2/dm_graph/flow/6.png?raw=true)
- Путь $Q$ разбивается на трансверсали пути $P$ пусть это $L_1,. . . , L_m$. Как показано выше, среди них есть хотя бы одна обратная стрелка пути $P$ а это неправильная трансверсаль.
- Пусть L правильная $x_ix_j$-трансверсаль пути $P$. Тогда все стрелки трансверсали $L$ лежат в $A(G_f)$. Если $L$ короче, чем $x_iPx_j$, то мы могли бы заменить этот участок пути $P$ на трансверсаль $L$ и найти в $G_f$ более короткий путь, чем $P$, противоречие с выбором пути $P$.
- Таким образом, каждая правильная трансверсаль пути $P$ не короче участка пути $P$ между ее концами. Заменим каждую правильную трансверсаль на соответствующий участок между ее концами. в результате получится $st$-маршрут $Q^′$, который не длиннее $st$-пути $Q$.
- Поскольку и $P$, и $Q^′$ ведут из $s$ в $t$, маршрут $Q^′$ содержит все рёбра пути $P$. Так как $Q$ (а стало быть, и $Q^′$) содержит хотя бы одну неправильную трансверсаль пути $P$, маршрут $Q^′$ (а следовательно, и путь $Q$) строго длиннее чем $P$.
- **Вернемся к доказательству Теоремы 4**
- После каждого шага алгоритма построения потока взамен одного из кратчайших путей из $s$ в $t$ в остаточной сети могут появиться лишь строго более длинные пути.
- Значит, в результате каждого шага либо увеличивается длина кратчайшего $st$-пути, либо эта длина сохраняется, но уменьшается количество кратчайших $st$-путей.
- Отметим, что кратчайший путь всегда простой, а длина простого пути из $s$ в $t$ ограничена количеством вершин сети. Значит, процесс построения закончится, и в результате получится остаточная сеть без дополняющих путей. По [Теореме 1](#теорема-1) это означает, что будет построен максимальный поток